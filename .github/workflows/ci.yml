name: CI

on:
  workflow_dispatch:
    inputs:
      deploy_ref:
        description: "Branch, tag, or SHA to deploy"
        required: false
        default: ""
      environment:
        description: "Deployment environment (for testing from feature branches)"
        required: false
        type: choice
        options:
          - production
          - testing
        default: "testing"
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  release:
    types: [published]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        python-version: ["3.9"]
    env:
      BEARER_TOKEN: test_token_ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.deploy_ref || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies (exclude Sense HAT)
        run: |
          python -m pip install --upgrade pip
          grep -v '^sense-hat' requirements.txt | grep -v '^#' | grep -v '^$' | xargs pip install

      - name: Run tests
        run: |
          python test_webhook_api.py
          python test_webhook.py
          python test_periodic_updates.py
          python test_api_models.py

  deploy:
    runs-on: self-hosted
    needs: tests
    timeout-minutes: 20
    # SECURITY: Only deploy from trusted sources (requires write access to repo)
    # - Manual trigger (workflow_dispatch) - requires write access
    # - Release published - requires write access
    # - Push to main/master - requires write access
    # NEVER runs on pull_request events (untrusted forks could execute malicious code)
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'release' ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    environment:
      name: production
      url: http://raspberrypi.local:8080
    steps:
      - name: Display deployment info
        run: |
          echo "Event: ${{ github.event_name }}"
          echo "Ref: ${{ github.ref }}"
          echo "Deploy ref: ${{ github.event.inputs.deploy_ref || github.ref }}"
          echo "Environment: ${{ github.event.inputs.environment || 'production' }}"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.deploy_ref || github.ref }}

      - name: Create .env from GitHub Secrets
        run: |
          # Validate required secrets
          missing=""
          for var in BEARER_TOKEN SLACK_WEBHOOK_URL; do
            if [ -z "${!var}" ]; then
              missing="$missing $var"
            fi
          done
          if [ -n "$missing" ]; then
            echo "Missing required secrets:$missing"
            exit 1
          fi

          # Create .env file with all configuration
          cat > .env <<EOF
BEARER_TOKEN=${BEARER_TOKEN}
CLOUDFLARED_TOKEN=${CLOUDFLARED_TOKEN}
SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
WEBHOOK_ENABLED=true
ALERT_TEMP_MIN_C=15.0
ALERT_TEMP_MAX_C=27.0
ALERT_HUMIDITY_MIN=30.0
ALERT_HUMIDITY_MAX=70.0
STATUS_UPDATE_ENABLED=true
STATUS_UPDATE_INTERVAL=3600
STATUS_UPDATE_ON_STARTUP=true
EOF
          chmod 600 .env
        env:
          BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
          CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Ensure logs directory
        run: mkdir -p logs

      - name: Deploy with Docker Compose
        run: docker compose -p temp-monitor up -d --build --remove-orphans
