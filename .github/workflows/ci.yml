name: CI

on:
  workflow_dispatch:
    inputs:
      deploy_ref:
        description: "Branch, tag, or SHA to deploy (manual runs only)"
        required: false
        default: ""
  push:
    branches: ["main", "master"]
  pull_request:
    branches: ["main", "master"]
  release:
    types: [published]

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  tests:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    strategy:
      matrix:
        python-version: ["3.9"]
    env:
      BEARER_TOKEN: test_token_ci
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.deploy_ref || github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
          cache: pip
          cache-dependency-path: requirements.txt

      - name: Install dependencies (exclude Sense HAT)
        run: |
          python -m pip install --upgrade pip
          REQS=$(python - <<'PY'
          from pathlib import Path
          lines = Path("requirements.txt").read_text().splitlines()
          reqs = [
              line.strip()
              for line in lines
              if line.strip() and not line.strip().startswith("#")
          ]
          reqs = [r for r in reqs if not r.startswith("sense-hat")]
          print(" ".join(reqs))
          PY
          )
          python -m pip install $REQS

      - name: Run tests
        run: |
          python test_webhook_api.py
          python test_webhook.py
          python test_periodic_updates.py
          python test_api_models.py

  deploy:
    runs-on: self-hosted
    needs: tests
    timeout-minutes: 20
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'release' ||
      (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master'))
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.inputs.deploy_ref || github.ref }}

      - name: Create .env from GitHub Secrets
        run: |
          if [ -z "${BEARER_TOKEN}" ]; then
            echo "Missing BEARER_TOKEN secret"
            exit 1
          fi
          if [ -z "${CLOUDFLARED_TOKEN}" ]; then
            echo "Missing CLOUDFLARED_TOKEN secret"
            exit 1
          fi
          if [ -z "${SLACK_WEBHOOK_URL}" ]; then
            echo "Missing SLACK_WEBHOOK_URL secret"
            exit 1
          fi
          cat > .env <<EOF
          BEARER_TOKEN=${BEARER_TOKEN}
          CLOUDFLARED_TOKEN=${CLOUDFLARED_TOKEN}
          SLACK_WEBHOOK_URL=${SLACK_WEBHOOK_URL}
          EOF
          chmod 600 .env
        env:
          BEARER_TOKEN: ${{ secrets.BEARER_TOKEN }}
          CLOUDFLARED_TOKEN: ${{ secrets.CLOUDFLARED_TOKEN }}
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}

      - name: Ensure logs directory
        run: mkdir -p logs

      - name: Deploy with Docker Compose
        run: docker compose up -d --build --remove-orphans
