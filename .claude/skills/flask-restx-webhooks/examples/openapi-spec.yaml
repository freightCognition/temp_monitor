# OpenAPI 3.0 Specification Example for Flask-RESTX Webhooks
#
# This is an example OpenAPI specification that demonstrates:
# - Webhook endpoint documentation
# - Security schemes (HMAC signature)
# - Request/response models
# - Error responses
# - Authentication requirements
#
# Note: Flask-RESTX generates OpenAPI 2.0 (Swagger) by default.
# This is a reference for what a modern OpenAPI 3.0+ spec looks like.

openapi: 3.0.3
info:
  title: Webhook Receiver API
  description: |
    A secure webhook receiving API with HMAC signature verification.

    ## Authentication

    All webhook endpoints require HMAC-SHA256 signature verification:

    1. Generate signature from request body
    2. Optionally include timestamp: `{timestamp}.{body}`
    3. Compute HMAC-SHA256 using shared secret
    4. Send as header: `X-Webhook-Signature: sha256={hex_digest}`

    ### Example (Python)

    ```python
    import hmac
    import hashlib

    secret = "your-secret-key"
    payload = '{"event_type":"test"}'
    signature = hmac.new(
        secret.encode(),
        payload.encode(),
        hashlib.sha256
    ).hexdigest()

    headers = {
        'X-Webhook-Signature': f'sha256={signature}'
    }
    ```
  version: 1.0.0
  contact:
    name: API Support
    email: api@example.com
    url: https://example.com/support
  license:
    name: MIT
    url: https://opensource.org/licenses/MIT

servers:
  - url: https://api.example.com/v1
    description: Production server
  - url: https://staging-api.example.com/v1
    description: Staging server
  - url: http://localhost:5000/api
    description: Local development

tags:
  - name: webhooks
    description: Webhook receiving endpoints
  - name: admin
    description: Administrative endpoints

security:
  - webhook_signature: []

paths:
  /webhooks/receive:
    post:
      tags:
        - webhooks
      summary: Receive webhook events
      description: |
        Main webhook endpoint for receiving events from external systems.

        Supported event types:
        - `user.created` - New user registration
        - `user.updated` - User profile update
        - `user.deleted` - User deletion
        - `order.placed` - New order
        - `order.completed` - Order fulfillment
        - `payment.received` - Payment processed

        The endpoint validates signatures, routes to handlers, and returns
        an acknowledgment with an assigned event ID for tracking.
      operationId: receiveWebhook
      security:
        - webhook_signature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/WebhookPayload'
            examples:
              userCreated:
                summary: User created event
                value:
                  event_type: user.created
                  timestamp: '2024-01-15T10:30:00Z'
                  data:
                    user_id: '12345'
                    email: user@example.com
                    name: John Doe
              orderPlaced:
                summary: Order placed event
                value:
                  event_type: order.placed
                  timestamp: '2024-01-15T10:35:00Z'
                  data:
                    order_id: 'ord_abc123'
                    total: 99.99
                    items:
                      - product_id: 'prod_1'
                        quantity: 2
      responses:
        '200':
          description: Webhook received and processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
        '400':
          description: Invalid payload structure
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: validation_error
                message: Invalid event_type format
        '401':
          description: Authentication failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              examples:
                missingSignature:
                  summary: Missing signature
                  value:
                    error: authentication_error
                    message: Missing signature header
                invalidSignature:
                  summary: Invalid signature
                  value:
                    error: authentication_error
                    message: Invalid signature
        '422':
          description: Validation error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ValidationError'
        '429':
          description: Rate limit exceeded
          headers:
            Retry-After:
              schema:
                type: integer
              description: Seconds to wait before retrying
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: rate_limit_exceeded
                message: Too many requests
                retry_after: 30
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/verify:
    post:
      tags:
        - webhooks
      summary: Verify signature
      description: Test endpoint to verify your signature generation is correct
      operationId: verifySignature
      security:
        - webhook_signature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
            example: {}
      responses:
        '200':
          description: Signature verified successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  verified:
                    type: boolean
                    example: true
                  message:
                    type: string
                    example: Signature is valid
                  timestamp:
                    type: string
                    example: '1705315800'
        '401':
          description: Invalid signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /webhooks/events:
    get:
      tags:
        - webhooks
      summary: List supported events
      description: Get a list of all supported webhook event types
      operationId: listEvents
      security: []  # Public endpoint
      responses:
        '200':
          description: List of supported event types
          content:
            application/json:
              schema:
                type: object
                properties:
                  supported_events:
                    type: array
                    items:
                      type: string
                    example:
                      - user.created
                      - user.updated
                      - order.placed
                  count:
                    type: integer
                    example: 3

  /health:
    get:
      tags:
        - admin
      summary: Health check
      description: Service health status
      operationId: healthCheck
      security: []  # Public endpoint
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time

components:
  securitySchemes:
    webhook_signature:
      type: apiKey
      in: header
      name: X-Webhook-Signature
      description: |
        HMAC-SHA256 signature of the request body.
        Format: sha256={hex_digest}

        Optionally include timestamp header for replay protection.

    webhook_timestamp:
      type: apiKey
      in: header
      name: X-Webhook-Timestamp
      description: |
        Unix timestamp when the signature was generated.
        Used for replay attack prevention (5 minute window).

  schemas:
    WebhookPayload:
      type: object
      required:
        - event_type
        - timestamp
        - data
      properties:
        event_type:
          type: string
          pattern: '^[a-z][a-z0-9_\.]+$'
          description: Event type identifier (lowercase, dot-separated)
          example: user.created
        timestamp:
          type: string
          format: date-time
          description: When the event occurred (ISO 8601)
          example: '2024-01-15T10:30:00Z'
        data:
          type: object
          description: Event-specific payload data
          additionalProperties: true
        metadata:
          type: object
          description: Optional metadata about the event
          additionalProperties: true

    WebhookResponse:
      type: object
      properties:
        status:
          type: string
          enum: [received, queued, processing, processed]
          description: Processing status
          example: received
        event_id:
          type: string
          description: Assigned event identifier for tracking
          example: evt_abc123xyz
        message:
          type: string
          description: Human-readable status message
          example: Webhook received successfully
        processed_at:
          type: string
          format: date-time
          description: When the webhook was processed

    ErrorResponse:
      type: object
      required:
        - error
        - message
      properties:
        error:
          type: string
          description: Error code/type
          example: authentication_error
        message:
          type: string
          description: Human-readable error message
          example: Invalid signature
        details:
          type: object
          description: Additional error details
          additionalProperties: true

    ValidationError:
      type: object
      properties:
        error:
          type: string
          example: validation_error
        message:
          type: string
          example: Request validation failed
        errors:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
                example: event_type
              message:
                type: string
                example: Field is required
              type:
                type: string
                example: required

# Webhooks (outgoing - what this API sends to subscribers)
# Note: This is OpenAPI 3.1+ feature for documenting outgoing webhooks
webhooks:
  eventProcessed:
    post:
      summary: Event processing complete
      description: |
        Notification sent when webhook event processing is complete.
        Subscribers must provide a callback URL.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                event_id:
                  type: string
                  example: evt_abc123
                status:
                  type: string
                  enum: [success, failed]
                result:
                  type: object
                  additionalProperties: true
      responses:
        '200':
          description: Callback acknowledged
